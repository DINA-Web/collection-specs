# Common query parameters for all DINA APIs
# Reference this file using: $ref: './components/common-parameters.yml#/FiqlFilter'

FiqlFilter:
  name: fiql
  in: query
  required: false
  description: |
    **FIQL (Feed Item Query Language) filter for querying resources.**
    
    FIQL provides a URI-friendly syntax for expressing filters. This parameter is supported
    across all DINA collection APIs for consistent querying.
    <details>
    <summary><strong>Comparison Operators</strong></summary>
    
    | Operator | Syntax | Description | Example |
    |----------|--------|-------------|---------|
    | Equal | `==` | Exact match | `catalogNumber==ABC123` |
    | Not Equal | `!=` | Does not match | `status!=archived` |
    | Greater Than | `=gt=` | Numeric/date comparison | `year=gt=2020` |
    | Greater or Equal | `=ge=` | Inclusive comparison | `count=ge=10` |
    | Less Than | `=lt=` | Numeric/date comparison | `year=lt=2025` |
    | Less or Equal | `=le=` | Inclusive comparison | `count=le=100` |
    | In | `=in=()` | Value in list | `status=in=(active,pending)` |
    | Out | `=out=()` | Value not in list | `type=out=(draft,archived)` |
    </details>
    
    <details>
    <summary><strong>Logical Operators</strong></summary>
    
    | Operator | Syntax | Description | Example |
    |----------|--------|-------------|---------|
    | AND | `;` | Both conditions must be true | `name==John;age=gt=25` |
    | OR | `,` | Either condition can be true | `status==active,status==pending` |
    | Grouping | `()` | Group conditions | `(field1==a,field1==b);field2==c` |
    
    </details>
    
    <details>
    <summary><strong>Wildcards</strong></summary>
    
    - `*` - Matches zero or more characters
    - `?` - Matches exactly one character
    
    **Examples:**
    - `name==John*` - Starts with "John"
    - `name==*Smith` - Ends with "Smith"
    - `name==*John*` - Contains "John"
    - `code==A?C` - A, any single character, then C
    
    </details>
    
    <details>
    <summary><strong>Query Examples</strong></summary>
    
    
    ### Simple Queries
    ```
    catalogNumber==ABC123
    scientificName==Quercus robur
    collectionYear==2023
    ```
    
    ### Wildcard Searches
    ```
    scientificName==*Quercus*
    commonName==*oak*
    locality==*Canada*
    ```
    
    ### Numeric Comparisons
    ```
    collectionYear=gt=2020
    specimenCount=ge=10
    latitude=lt=45.5
    ```
    
    ### Date Ranges
    ```
    collectedDate=ge=2020-01-01;collectedDate=le=2024-12-31
    modifiedDate=gt=2024-01-01
    ```
    
    ### Multiple Values
    ```
    status=in=(active,pending,review)
    collectionCode=in=(BOTANY,ZOOLOGY,GEOLOGY)
    preparationType=out=(deleted,archived)
    ```
    
    ### Combined Conditions (AND)
    ```
    scientificName==*Quercus*;collectionYear=gt=2020
    status==active;preparationType==mounted;collectionYear=ge=2023
    ```
    
    ### Combined Conditions (OR)
    ```
    status==active,status==pending
    scientificName==*Quercus robur*,scientificName==*Quercus petraea*
    ```
    
    ### Complex Queries with Grouping
    ```
    (scientificName==*Quercus*,commonName==*oak*);collectionYear=gt=2020
    (status==active,status==pending);preparationType!=digital;collectionYear=ge=2023
    ```
    
    </details>
    
    <details><summary><strong>Important Notes</strong></summary>
    
    1. **URL Encoding**: Special characters must be URL-encoded in actual requests
       - Space: `%20`
       - `;` (AND): `%3B`
       - `,` (OR): `%2C`
    
    2. **Case Sensitivity**: 
       - Field names are case-sensitive
       - String values are typically case-insensitive (implementation-dependent)
    
    3. **Performance**: Leading wildcards (`*term`) may impact query performance
    
    4. **Field Support**: Not all fields support all operators. See endpoint-specific documentation.
    
    </details>
    
    [Complete FIQL Documentation](https://dina-web.github.io/collection-specs/docs/fiql-reference)
    
  schema:
    type: string

# Simple Search Filter - Key-value based filtering
# Format: filter[field.subfield][OPERATOR]=value
SimpleSearchFilter:
  name: filter
  in: query
  required: false
  style: deepObject
  explode: true
  description: |
    **Simple search filter using key-value pairs with nested properties.**
    
    Filter results by specifying field paths and comparison operators.
    
    
    
    <details>
    <summary><strong>Filter Syntax</strong></summary>
    
    ```
    filter[fieldName][OPERATOR]=value
    filter[parent.child][OPERATOR]=value
    filter[parent.child.grandchild][OPERATOR]=value
    ```
    
    </details>
    
    <details>
    <summary><strong>Supported Operators</strong></summary>
    
    | Operator | Description | Example |
    |----------|-------------|---------|
    | `EQ` | Equal to | `filter[status][EQ]=active` |
    | `NEQ` | Not equal to | `filter[status][NEQ]=archived` |
    | `GT` | Greater than | `filter[year][GT]=2020` |
    | `GTE` | Greater than or equal | `filter[year][GTE]=2020` |
    | `LT` | Less than | `filter[year][LT]=2025` |
    | `LTE` | Less than or equal | `filter[year][LTE]=2024` |
    | `IN` | In list (comma-separated) | `filter[status][IN]=active,pending` |
    | `LIKE` | Pattern match (use % for wildcard) | `filter[name][LIKE]=%oak%` |
    | `ILIKE` | Case-insensitive pattern match | `filter[name][ILIKE]=%OAK%` |
    | `IS_NULL` | Is null | `filter[deletedDate][IS_NULL]=true` |
    | `NOT_NULL` | Is not null | `filter[deletedDate][NOT_NULL]=true` |
    
    </details>
    
    
    <details>
    <summary><strong>Examples</strong></summary>
    
    ### Simple Equality
    ```
    filter[catalogNumber][EQ]=ABC123
    filter[status][EQ]=active
    ```
    
    ### Nested Properties
    ```
    filter[storageUnitType.uuid][EQ]=0193bc05-5d49-7b99-89ea-7c97d2dcd7bd
    filter[collection.code][EQ]=BOTANY
    filter[determination.scientificName][LIKE]=%Quercus%
    ```
    
    ### Numeric Comparisons
    ```
    filter[collectionYear][GTE]=2020
    filter[specimenCount][LT]=100
    filter[latitude][GT]=45.5
    ```
    
    ### Multiple Values (IN operator)
    ```
    filter[status][IN]=active,pending,review
    filter[collectionCode][IN]=BOTANY,ZOOLOGY
    ```
    
    ### Pattern Matching
    ```
    filter[scientificName][LIKE]=%Quercus%
    filter[locality][ILIKE]=%canada%
    ```
    
    ### Null Checks
    ```
    filter[deletedDate][IS_NULL]=true
    filter[verifiedBy][NOT_NULL]=true
    ```
    
    ### Multiple Filters (AND logic)
    ```
    filter[status][EQ]=active&filter[collectionYear][GTE]=2020
    filter[storageUnitType.uuid][EQ]=abc123&filter[preparationType][EQ]=mounted
    ```
    
    </details>

    <details>
    
    <summary><strong>Nested Property Paths</strong></summary>
    
    Use dot notation to filter on nested/related objects:
    
    ```
    filter[relationship.property][OPERATOR]=value
    ```
    
    ### Common Nested Paths
    
    | Path | Description | Example |
    |------|-------------|---------|
    | `storageUnitType.uuid` | Storage unit type ID | `filter[storageUnitType.uuid][EQ]=abc-123` |
    | `storageUnitType.name` | Storage unit type name | `filter[storageUnitType.name][LIKE]=%freezer%` |
    | `collection.code` | Collection code | `filter[collection.code][EQ]=BOTANY` |
    | `collection.name` | Collection name | `filter[collection.name][LIKE]=%herbarium%` |
    | `determination.scientificName` | Determined name | `filter[determination.scientificName][EQ]=Quercus robur` |
    | `collectingEvent.locality` | Collection locality | `filter[collectingEvent.locality][LIKE]=%Canada%` |
    
    </details>

    <details>
    <summary><strong>Important Notes</strong></summary>
    
    1. **Multiple Filters**: Use `&` to combine multiple filters (AND logic)
    2. **URL Encoding**: Special characters must be URL-encoded
       - Space: `%20`
       - `%` wildcard: `%25` (for LIKE patterns)
    3. **Case Sensitivity**: Field names are case-sensitive
    4. **Operator Format**: Operators must be in UPPERCASE
    5. **Wildcards**: Use `%` for wildcards in LIKE/ILIKE patterns
    
    </details>
    
    <details>
    <summary><strong>URL-Encoded Examples</strong></summary>
    
    ```
    # Before encoding:
    filter[storageUnitType.uuid][EQ]=0193bc05-5d49-7b99-89ea-7c97d2dcd7bd
    
    # After encoding:
    filter%5BstorageUnitType.uuid%5D%5BEQ%5D=0193bc05-5d49-7b99-89ea-7c97d2dcd7bd
    ```
    
    ```
    # Before encoding:
    filter[scientificName][LIKE]=%Quercus%
    
    # After encoding:
    filter%5BscientificName%5D%5BLIKE%5D=%25Quercus%25
    ```
    </details>
    
  schema:
    type: object
    additionalProperties:
      type: object
      additionalProperties:
        type: string

Sort:
  in: query
  name: sort
  description: optional sort order string, such as descending, denoted by "-"
  schema:
    type: string

PageOffset:
  in: query
  name: page[offset]
  description: number of records to skip when paging
  schema:
    type: integer
    format: int32

PageLimit:
  in: query
  name: page[limit]
  description: maximum number of records to return when paging
  schema:
    type: integer
    format: int32
    minimum: 0
    maximum: 50

GeoReferenceAssertions:
  type: array
  nullable: true
  items:
    type: object
    properties:
      dwcDecimalLatitude:
        type: number
        nullable: true
        description: geographic location's latitude, https://dwc.tdwg.org/list/#dwc_decimalLatitude
      dwcDecimalLongitude:
        type: number
        nullable: true
        description: geographic location's longitude, http://rs.tdwg.org/dwc/terms/decimalLongitude
      dwcCoordinateUncertaintyInMeters:
        type: number
        nullable: true
        description: horizontal distance (in meters) from the given decimalLatitude and decimalLongitude describing the smallest circle containing the whole of the Location, https://dwc.tdwg.org/terms/#dwc:coordinateUncertaintyInMeters
      dwcGeoreferencedDate:
        type: string
        format: date
        nullable: true
        description: The date on which the Location was georeferenced.
      georeferencedBy:
        type: array
        nullable: true
        description: A list of uuid who determined the georeference for the location.
        items:
          type: string
          format: uuid
      literalGeoreferencedBy:
        type: string
        nullable: true
        description: A name of a person, group or organization who determined the georeference for the location.
      dwcGeoreferenceProtocol:
        type: string
        nullable: true
        description: A description or reference to the methods used to determine the spatial footprint, coordinates, and uncertainties.
      dwcGeoreferenceSources:
        type: string
        nullable: true
        description: A map, gazetteer, or other resource used to georeference the Location.
      dwcGeoreferenceRemarks:
        type: string
        nullable: true
        description: Notes or comments about the spatial description determination, explaining assumptions made in addition or opposition to the those formalized in the method referred to in georeferenceProtocol.
        minLength: 0
        maxLength: 1000
      dwcGeodeticDatum:
        type: string
        nullable: true
        description: The ellipsoid, geodetic datum, or spatial reference system (SRS) upon which the geographic coordinates given in decimalLatitude and decimalLongitude as based.
      isPrimary:
        type: boolean
        description: specify whether or not the georeference assertion is the primary of the colecting-event
      dwcGeoreferenceVerificationStatus:
        type: string
        nullable: true
        enum: [null, GEOREFERENCING_NOT_POSSIBLE]
      createdOn:
        type: string
        format: date-time
        readOnly: true

ResponseMeta:
  type: object
  properties:
    moduleVersion:
      type: number
      readOnly: true
      description: API module version number.

ResponseMetaWithResourceCount:
  type: object
  properties:
    moduleVersion:
      type: number
      readOnly: true
      description: API module version number.
    totalResourceCount:
      type: integer
      readOnly: true
      description: Total number of resources available for the given query (ignoring pagination).

PermissionsMeta:
      type: object
      description: |
        Metadata containing authorization and permissions information.
        
        The `permissions` array indicates which operations the authenticated user 
        is authorized to perform on this resource. Only enabled permissions are 
        included in the array. An empty array means no permissions are granted.
        
        Examples:
        - `["create", "update", "delete"]` - Full access
        - `["update"]` - Can only update
        - `[]` - Read-only access
      properties:
        permissionsProvider:
          type: string
          readOnly: true
          example: GroupAuthorizationService
          description: The authorization service that determined these permissions
        permissions:
          type: array
          readOnly: true
          minItems: 0
          maxItems: 3
          items:
            type: string
            enum: [create, update, delete]
          example: ["create", "update", "delete"]
          uniqueItems: true
          description: |
            Array of enabled permission operations. Possible values:
            - `create` - Authorization to create new resources
            - `update` - Authorization to modify this resource
            - `delete` - Authorization to delete this resource
            
            If a permission is present in the array, it is enabled.
            If a permission is absent from the array, it is disabled.

Attachment:
  type: object
  nullable: true
  properties:
    data:
      type: array
      items:
        type: object
        required:
          - type
          - id
        properties:
          type: 
            type: string
            example: metadata
          id:
            type: string
            format: uuid
            description: Unique identifier metadata for the resource
            example: 8f68a05f-937d-4d40-88b4-ed92720d9c3f

BadRequest:
  type: object
  required:
    - errors
  properties:
    errors:
      type: array
      items:
        type: object
        properties:
          status:
            type: string
            example: "400 BAD_REQUEST"
          code:
            type: string
            example: "400"
          title:
            type: string
            example: "Bad Request"
          detail:
            type: string
            example: "Invalid UUID string: 019c0576-3ba6-7b64-b45"

UnprocessableEntity:
  type: object
  required:
    - errors
  properties:
    errors:
      type: array
      items:      
        type: object
        properties:
          status:
            type: string
            example: "422 UNPROCESSABLE_ENTITY"
          code:
            type: string
            example: "422"
          title:
            type: string
            example: "Constraint violation"
          detail:
            type: string
            example: "name must not be blank"
          source:
            type: object
            properties:
              pointer:
                type: string
                example: "name"

